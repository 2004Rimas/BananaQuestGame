<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile ‚Äî Banana Quest</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="header">
    <div class="brand">
      <div class="logo">üçå</div>
      <div>
        <div class="title">Banana Quest</div>
        <div class="hint">Profile</div>
      </div>
    </div>
    <div class="header-actions">
      <a href="/index.html" class="btn">Back to Game</a>
      <a href="/logout" class="btn">Logout</a>
    </div>
  </header>

  <main style="padding:28px; max-width:900px; margin:0 auto;">
    <section class="card" style="display:flex;gap:20px;align-items:flex-start;">
      <div style="width:220px; text-align:center;">
        <img id="avatar" src="" alt="avatar" style="width:160px;height:160px;border-radius:12px;object-fit:cover;border:3px solid rgba(255,193,7,0.12)" />
        <div style="margin-top:12px;">
          <input id="avatarUrl" class="input" placeholder="Avatar image URL" />
          <button id="saveAvatar" class="btn" style="margin-top:8px;width:100%;">Save Avatar</button>
        </div>
      </div>

      <div style="flex:1;">
        <h2 id="nameHeading">Your name</h2>
        <p id="emailLine" class="hint">email@example.com</p>

        <div style="margin-top:14px;">
          <h3 style="margin-bottom:8px">Your Scores</h3>
          <div id="profileScores" style="display:flex;flex-direction:column;gap:8px;"></div>
        </div>

        <div style="margin-top:18px;">
          <h3>Change display name</h3>
          <input id="displayName" class="input" placeholder="New display name" />
          <button id="saveName" class="btn" style="margin-top:8px;">Save Name</button>
          <p id="profileMsg" class="hint"></p>
        </div>
      </div>
    </section>
  </main>

<script>
async function loadProfile() {
  try {
    const r = await fetch("/api/profile");
    if (!r.ok) {
      window.location.href = "/login.html";
      return;
    }
    const json = await r.json();
    const u = json.user;
    document.getElementById("nameHeading").textContent = u.name;
    document.getElementById("emailLine").textContent = u.email;
    document.getElementById("avatar").src = u.avatar || "/default-avatar.png";
    document.getElementById("avatarUrl").value = u.avatar || "";

    // scores
    const scoresEl = document.getElementById("profileScores");
    scoresEl.innerHTML = "";
    json.scores.forEach((s, i) => {
      const p = document.createElement("div");
      p.className = "my-achievement";
      p.style.padding = "10px";
      p.style.background = "#fff";
      p.style.borderRadius = "10px";
      p.textContent = `${i+1}. ${s.score} pts ‚Äî ${new Date(s.createdAt).toLocaleString()}`;
      scoresEl.appendChild(p);
    });
  } catch (err) {
    console.error(err);
  }
}

document.getElementById("saveAvatar").addEventListener("click", async () => {
  const val = document.getElementById("avatarUrl").value.trim();
  try {
    const r = await fetch("/api/profile", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ avatar: val })
    });
    const json = await r.json();
    document.getElementById("profileMsg").textContent = json.message || "Saved";
    loadProfile();
  } catch (err) { console.error(err); }
});

document.getElementById("saveName").addEventListener("click", async () => {
  const val = document.getElementById("displayName").value.trim();
  if (!val) return;
  try {
    const r = await fetch("/api/profile", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: val })
    });
    const json = await r.json();
    document.getElementById("profileMsg").textContent = json.message || "Saved";
    loadProfile();
  } catch (err) { console.error(err); }
});

loadProfile();
</script>
</body>
</html>
